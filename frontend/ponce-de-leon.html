<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ponce & Clifton - Atlanta Int Monitor</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #0d0d12;
      --bg-secondary: #151520;
      --bg-card: #1a1a28;
      --bg-header: #12121a;
      --accent: #7dd3fc;
      --accent-glow: rgba(125, 211, 252, 0.2);
      --accent-secondary: #ffb07c;
      --peach: #f4a259;
      --peach-glow: rgba(244, 162, 89, 0.2);
      --text-primary: #f0f4f8;
      --text-secondary: #94a3b8;
      --text-muted: #64748b;
      --border: rgba(255, 255, 255, 0.08);
      --success: #4ade80;
      --arm1-color: #ef5350;
      --arm3-color: #66bb6a;
      --arm5-color: #ffca28;
      --arm7-color: #42a5f5;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Outfit', sans-serif;
      background: var(--bg-primary);
      min-height: 100vh;
      color: var(--text-primary);
    }

    .widget-container {
      max-width: 1200px;
      margin: 0 auto;
      background: var(--bg-secondary);
    }

    /* Widget Header */
    .widget-header {
      background: var(--bg-header);
      padding: 16px 20px;
      display: flex;
      align-items: center;
      gap: 16px;
      border-bottom: 1px solid var(--border);
    }

    .logo {
      height: 48px;
      width: auto;
    }

    .header-title {
      flex: 1;
    }

    .header-title h1 {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .header-title span {
      font-size: 12px;
      color: var(--text-muted);
      font-family: 'JetBrains Mono', monospace;
    }

    .widget-actions {
      display: flex;
      gap: 8px;
    }

    .widget-actions a,
    .widget-actions button {
      background: var(--bg-card);
      border: 1px solid var(--border);
      color: var(--text-secondary);
      cursor: pointer;
      padding: 8px 16px;
      font-size: 13px;
      font-family: 'Outfit', sans-serif;
      border-radius: 6px;
      text-decoration: none;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .widget-actions a:hover,
    .widget-actions button:hover {
      background: var(--bg-primary);
      border-color: var(--accent);
      color: var(--accent);
    }

    /* Status Bar */
    .status-bar {
      padding: 12px 20px;
      background: var(--bg-card);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 20px;
      font-size: 13px;
      color: var(--text-secondary);
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
      box-shadow: 0 0 10px var(--success);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* Info Section */
    .info-section {
      padding: 20px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      border-bottom: 1px solid var(--border);
    }

    .arm-labels {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 13px;
    }

    .arm-label {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .arm-color {
      width: 20px;
      height: 4px;
      border-radius: 2px;
    }

    .arm-color.arm1 { background: var(--arm1-color); }
    .arm-color.arm3 { background: var(--arm3-color); }
    .arm-color.arm5 { background: var(--arm5-color); }
    .arm-color.arm7 { background: var(--arm7-color); }

    .date-info {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 13px;
    }

    .date-info .label {
      color: var(--text-muted);
      min-width: 100px;
      display: inline-block;
    }

    .date-info .value {
      font-weight: 500;
      color: var(--accent);
    }

    /* Flow Diagram Section */
    .flow-section {
      padding: 30px 20px;
      display: flex;
      justify-content: center;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(180deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
    }

    .intersection-diagram {
      position: relative;
      width: 380px;
      height: 380px;
    }

    .arm-box {
      position: absolute;
      background: var(--bg-card);
      border: 2px solid;
      border-radius: 8px;
      padding: 10px 14px;
      font-size: 12px;
      min-width: 90px;
      text-align: center;
    }

    .arm-box.north { 
      top: 0; 
      left: 50%; 
      transform: translateX(-50%);
      border-color: var(--arm3-color);
    }
    .arm-box.south { 
      bottom: 0; 
      left: 50%; 
      transform: translateX(-50%);
      border-color: var(--arm7-color);
    }
    .arm-box.west { 
      left: 0; 
      top: 50%; 
      transform: translateY(-50%);
      border-color: var(--arm5-color);
    }
    .arm-box.east { 
      right: 0; 
      top: 50%; 
      transform: translateY(-50%);
      border-color: var(--arm1-color);
    }

    .arm-box .arm-name {
      font-weight: 600;
      margin-bottom: 4px;
      padding: 3px 8px;
      border-radius: 4px;
      color: white;
      font-size: 11px;
    }

    .arm-box.north .arm-name { background: var(--arm3-color); }
    .arm-box.south .arm-name { background: var(--arm7-color); }
    .arm-box.west .arm-name { background: var(--arm5-color); }
    .arm-box.east .arm-name { background: var(--arm1-color); }

    .arm-stats {
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      color: var(--text-muted);
    }

    .flow-center {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 200px;
      height: 200px;
    }

    /* Tables Section */
    .tables-section {
      padding: 20px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      border-bottom: 1px solid var(--border);
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    .data-table th {
      background: linear-gradient(135deg, var(--accent), #38bdf8);
      color: var(--bg-primary);
      padding: 10px 12px;
      text-align: left;
      font-weight: 600;
    }

    .data-table th:first-child {
      border-radius: 6px 0 0 0;
    }

    .data-table th:last-child {
      border-radius: 0 6px 0 0;
    }

    .data-table td {
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      background: var(--bg-card);
    }

    .data-table tr:hover td {
      background: var(--bg-primary);
    }

    .data-table .route {
      font-weight: 600;
    }

    .data-table .route.arm1 { color: var(--arm1-color); }
    .data-table .route.arm3 { color: var(--arm3-color); }
    .data-table .route.arm5 { color: var(--arm5-color); }
    .data-table .route.arm7 { color: var(--arm7-color); }

    .data-table .number {
      font-family: 'JetBrains Mono', monospace;
      text-align: right;
    }

    .data-table td:nth-child(2) {
      color: var(--text-muted);
      max-width: 120px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* Chart Section */
    .chart-section {
      padding: 20px;
      border-bottom: 1px solid var(--border);
    }

    .chart-container {
      position: relative;
      height: 280px;
      background: var(--bg-card);
      border-radius: 8px;
      padding: 16px 16px 24px 16px;
    }

    .chart-legend {
      display: flex;
      justify-content: center;
      gap: 24px;
      margin-bottom: 16px;
      font-size: 12px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .legend-color {
      width: 20px;
      height: 10px;
      border-radius: 3px;
    }

    /* Footer Controls */
    .footer-controls {
      padding: 16px 20px;
      background: var(--bg-card);
      display: flex;
      align-items: center;
      gap: 20px;
      font-size: 12px;
    }

    .toggle-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .toggle-switch {
      width: 36px;
      height: 20px;
      background: var(--bg-primary);
      border-radius: 10px;
      position: relative;
      cursor: pointer;
      transition: background 0.2s;
      border: 1px solid var(--border);
    }

    .toggle-switch.active {
      background: var(--accent);
    }

    .toggle-switch::after {
      content: '';
      position: absolute;
      width: 14px;
      height: 14px;
      background: white;
      border-radius: 50%;
      top: 2px;
      left: 3px;
      transition: left 0.2s;
    }

    .toggle-switch.active::after {
      left: 18px;
    }

    .date-nav {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .date-nav button {
      background: var(--bg-primary);
      border: 1px solid var(--border);
      color: var(--text-secondary);
      padding: 6px 10px;
      cursor: pointer;
      border-radius: 4px;
      font-size: 12px;
    }

    .date-nav button:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .date-nav input {
      background: var(--bg-primary);
      border: 1px solid var(--border);
      color: var(--text-primary);
      padding: 6px 10px;
      font-size: 12px;
      width: 110px;
      border-radius: 4px;
    }

    /* Raw JSON Toggle */
    .raw-toggle {
      margin: 20px;
    }

    .raw-toggle summary {
      cursor: pointer;
      font-size: 12px;
      color: var(--text-muted);
      padding: 10px 14px;
      background: var(--bg-card);
      border-radius: 6px;
      border: 1px solid var(--border);
      list-style: none;
    }

    .raw-toggle summary::-webkit-details-marker {
      display: none;
    }

    .raw-toggle[open] summary {
      border-radius: 6px 6px 0 0;
    }

    .raw-content {
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-top: none;
      border-radius: 0 0 6px 6px;
      padding: 14px;
      max-height: 200px;
      overflow: auto;
    }

    .raw-content pre {
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      color: var(--text-muted);
      white-space: pre-wrap;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .info-section,
      .tables-section {
        grid-template-columns: 1fr;
      }

      .intersection-diagram {
        width: 300px;
        height: 300px;
      }
    }
  </style>
</head>
<body>
  <div class="widget-container">
    <!-- Header -->
    <div class="widget-header">
      <img src="/images/logo.png" alt="Atlanta Logo" class="logo">
      <div class="header-title">
        <h1>Ponce & Clifton</h1>
        <span id="widgetTitle">[--] Movement set statistics</span>
      </div>
      <div class="widget-actions">
        <a href="/">← Home</a>
        <button id="refreshBtn">↻ Refresh</button>
      </div>
    </div>

    <!-- Status Bar -->
    <div class="status-bar">
      <div class="status-indicator">
        <span class="status-dot"></span>
        <span id="statusText">Running</span>
      </div>
      <span id="dateRangeText">From -- to --</span>
      <span id="snapshotsText">Snapshots: --</span>
    </div>

    <!-- Info Section -->
    <div class="info-section">
      <div class="arm-labels" id="armLabels">
        <div class="arm-label"><span class="arm-color arm1"></span> Arm 1: East Arm 1</div>
        <div class="arm-label"><span class="arm-color arm3"></span> Arm 3: North Arm 3</div>
        <div class="arm-label"><span class="arm-color arm5"></span> Arm 5: West Arm 5</div>
        <div class="arm-label"><span class="arm-color arm7"></span> Arm 7: South Arm 7</div>
      </div>
      <div class="date-info" id="dateInfo">
        <div><span class="label">Date:</span> <span class="value" id="dateValue">--</span></div>
        <div><span class="label">Time:</span> <span class="value" id="timeValue">--</span></div>
        <div><span class="label">Granularity:</span> <span class="value" id="granularityValue">--</span></div>
      </div>
    </div>

    <!-- Flow Diagram -->
    <div class="flow-section">
      <div class="intersection-diagram" id="intersectionDiagram">
        <div class="arm-box north">
          <div class="arm-name" id="arm3Name">N (Arm 3)</div>
          <div class="arm-stats" id="arm3Stats">--</div>
        </div>
        <div class="arm-box east">
          <div class="arm-name" id="arm1Name">E (Arm 1)</div>
          <div class="arm-stats" id="arm1Stats">--</div>
        </div>
        <div class="arm-box south">
          <div class="arm-name" id="arm7Name">S (Arm 7)</div>
          <div class="arm-stats" id="arm7Stats">--</div>
        </div>
        <div class="arm-box west">
          <div class="arm-name" id="arm5Name">W (Arm 5)</div>
          <div class="arm-stats" id="arm5Stats">--</div>
        </div>
        <svg class="flow-center" viewBox="0 0 200 200" id="flowDiagram">
          <!-- Flow lines showing traffic between arms - updated dynamically -->
          <path id="flowPath5" d="M 0,90 Q 100,90 100,100 Q 100,110 200,110" stroke="#ffca28" stroke-width="2" fill="none" opacity="0.7"/>
          <path id="flowPath1" d="M 200,90 Q 100,90 100,100 Q 100,110 0,110" stroke="#ef5350" stroke-width="2" fill="none" opacity="0.7"/>
          <path id="flowPath3" d="M 90,0 Q 90,100 100,100 Q 110,100 110,200" stroke="#66bb6a" stroke-width="2" fill="none" opacity="0.7"/>
          <path id="flowPath7" d="M 110,0 Q 110,100 100,100 Q 90,100 90,200" stroke="#42a5f5" stroke-width="2" fill="none" opacity="0.7"/>
        </svg>
      </div>
    </div>

    <!-- Tables Section -->
    <div class="tables-section">
      <div>
        <table class="data-table" id="movementsTable1">
          <thead>
            <tr>
              <th>MOVEMENT</th>
              <th>Name</th>
              <th>Count</th>
              <th>Avg Time</th>
            </tr>
          </thead>
          <tbody id="movementsBody1">
            <tr><td colspan="4" style="text-align:center;color:var(--text-muted);">No data</td></tr>
          </tbody>
        </table>
      </div>
      <div>
        <table class="data-table" id="movementsTable2">
          <thead>
            <tr>
              <th>MOVEMENT</th>
              <th>Name</th>
              <th>Count</th>
              <th>Avg Time</th>
            </tr>
          </thead>
          <tbody id="movementsBody2">
            <tr><td colspan="4" style="text-align:center;color:var(--text-muted);">No data</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Chart Section -->
    <div class="chart-section">
      <div class="chart-legend" id="chartLegend">
        <div class="legend-item"><span class="legend-color" style="background:rgba(239,83,80,0.5);border:2px solid #ef5350;"></span> <span id="leg1">Arm 1 (E)</span></div>
        <div class="legend-item"><span class="legend-color" style="background:rgba(102,187,106,0.5);border:2px solid #66bb6a;"></span> <span id="leg3">Arm 3 (N)</span></div>
        <div class="legend-item"><span class="legend-color" style="background:rgba(255,202,40,0.5);border:2px solid #ffca28;"></span> <span id="leg5">Arm 5 (W)</span></div>
        <div class="legend-item"><span class="legend-color" style="background:rgba(66,165,245,0.5);border:2px solid #42a5f5;"></span> <span id="leg7">Arm 7 (S)</span></div>
      </div>
      <div class="chart-container">
        <canvas id="timeChart"></canvas>
      </div>
    </div>

    <!-- Footer Controls -->
    <div class="footer-controls">
      <div class="toggle-group">
        <input type="checkbox" id="heavyToggle">
        <label for="heavyToggle">Heavy</label>
      </div>
      <div class="toggle-group">
        <span class="toggle-switch active" id="historyToggle"></span>
        <label>History</label>
      </div>
      <div class="date-nav">
        <span>Date range:</span>
        <button>«</button>
        <button>‹</button>
        <input type="date" id="dateInput" value="2026-01-20">
        <button>›</button>
        <button>»</button>
      </div>
    </div>

    <!-- Raw JSON -->
    <details class="raw-toggle" id="rawToggle" style="display:none;">
      <summary>▶ View raw JSON data</summary>
      <div class="raw-content">
        <pre id="jsonView">{}</pre>
      </div>
    </details>
  </div>

  <script>
    let chart = null;
    let lastDataHash = null;

    function initChart() {
      const ctx = document.getElementById('timeChart').getContext('2d');
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [
            { 
              label: 'Arm 1', 
              data: [], 
              borderColor: '#ef5350', 
              backgroundColor: 'rgba(239,83,80,0.5)', 
              fill: true,
              tension: 0.3,
              pointRadius: 4,
              pointBackgroundColor: '#ef5350',
              pointBorderColor: '#fff',
              pointBorderWidth: 1,
              order: 4
            },
            { 
              label: 'Arm 3', 
              data: [], 
              borderColor: '#66bb6a', 
              backgroundColor: 'rgba(102,187,106,0.5)', 
              fill: true,
              tension: 0.3,
              pointRadius: 4,
              pointBackgroundColor: '#66bb6a',
              pointBorderColor: '#fff',
              pointBorderWidth: 1,
              order: 3
            },
            { 
              label: 'Arm 5', 
              data: [], 
              borderColor: '#ffca28', 
              backgroundColor: 'rgba(255,202,40,0.5)', 
              fill: true,
              tension: 0.3,
              pointRadius: 4,
              pointBackgroundColor: '#ffca28',
              pointBorderColor: '#fff',
              pointBorderWidth: 1,
              order: 2
            },
            { 
              label: 'Arm 7', 
              data: [], 
              borderColor: '#42a5f5', 
              backgroundColor: 'rgba(66,165,245,0.5)', 
              fill: true,
              tension: 0.3,
              pointRadius: 4,
              pointBackgroundColor: '#42a5f5',
              pointBorderColor: '#fff',
              pointBorderWidth: 1,
              order: 1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false
          },
          plugins: { 
            legend: { display: false },
            tooltip: {
              backgroundColor: 'rgba(26,26,40,0.95)',
              titleColor: '#f0f4f8',
              bodyColor: '#94a3b8',
              borderColor: 'rgba(255,255,255,0.1)',
              borderWidth: 1,
              padding: 12,
              displayColors: true
            }
          },
          scales: {
            x: { 
              grid: { color: 'rgba(255,255,255,0.05)' }, 
              ticks: { 
                color: '#64748b',
                font: { size: 10 },
                maxRotation: 45,
                minRotation: 45
              }
            },
            y: { 
              beginAtZero: true, 
              stacked: false,
              grid: { color: 'rgba(255,255,255,0.05)' }, 
              ticks: { 
                color: '#64748b',
                font: { size: 11 }
              },
              suggestedMax: 1600
            }
          }
        }
      });
    }

    function parseTimestamp(ts) {
      if (!ts) return null;
      if (ts > 1e15) return new Date(ts / 1000000);
      if (ts > 1e12) return new Date(ts);
      return new Date(ts * 1000);
    }

    function formatGranularity(ms) {
      if (!ms) return '--';
      const minutes = ms / 60000;
      return minutes < 60 ? `${minutes} minutes` : `${minutes / 60} hours`;
    }

    function hashData(data) { return JSON.stringify(data); }

    function getArmColor(armNum) {
      return { 1: 'arm1', 3: 'arm3', 5: 'arm5', 7: 'arm7' }[armNum] || 'arm1';
    }

    function updateFlowDiagram(armTotals) {
      // Calculate stroke widths based on vehicle volumes
      // Scale from 2px (min) to 20px (max) based on the maximum volume
      const maxVolume = Math.max(armTotals[1] || 0, armTotals[3] || 0, armTotals[5] || 0, armTotals[7] || 0);
      const minStroke = 2;
      const maxStroke = 20;
      
      const calculateStroke = (volume) => {
        if (maxVolume === 0) return minStroke;
        return minStroke + ((volume / maxVolume) * (maxStroke - minStroke));
      };
      
      // Update each flow path with calculated stroke width
      document.getElementById('flowPath1').setAttribute('stroke-width', calculateStroke(armTotals[1] || 0));
      document.getElementById('flowPath3').setAttribute('stroke-width', calculateStroke(armTotals[3] || 0));
      document.getElementById('flowPath5').setAttribute('stroke-width', calculateStroke(armTotals[5] || 0));
      document.getElementById('flowPath7').setAttribute('stroke-width', calculateStroke(armTotals[7] || 0));
    }

    // Arm position to label mapping (from FLOW cartogram)
    const armLabels = { 1: 'E', 3: 'N', 5: 'W', 7: 'S' };
    const armFullNames = { 1: 'East', 3: 'North', 5: 'West', 7: 'South' };

    function updateDisplay(data) {
      const innerData = data.data || data;
      
      // Check if data object is empty
      const isDataEmpty = !innerData || Object.keys(innerData).length === 0;
      
      document.getElementById('widgetTitle').textContent = 
        `[${data.id ?? data.analytic_id ?? '--'}] ${data.name || data.block_name || 'Movement set statistics'}`;
      
      if (isDataEmpty) {
        document.getElementById('snapshotsText').textContent = '⚠️ Receiving webhooks but data field is empty';
        document.getElementById('statusText').textContent = 'Connected (no data)';
        console.warn('Webhook received but data.data is empty:', data);
      }
      
      const startDate = parseTimestamp(data.data_start_timestamp);
      const endDate = parseTimestamp(data.data_end_timestamp);
      
      if (startDate && endDate && !isNaN(startDate) && !isNaN(endDate)) {
        document.getElementById('dateRangeText').textContent = `From ${startDate.toLocaleDateString()} to ${endDate.toLocaleDateString()}`;
        document.getElementById('dateValue').textContent = `${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()}`;
        document.getElementById('timeValue').textContent = `${startDate.toLocaleTimeString()} - ${endDate.toLocaleTimeString()}`;
        document.getElementById('dateInput').value = startDate.toISOString().split('T')[0];
      } else {
        const now = new Date();
        document.getElementById('dateRangeText').textContent = `Updated: ${now.toLocaleString()}`;
        document.getElementById('dateValue').textContent = now.toLocaleDateString();
        document.getElementById('timeValue').textContent = now.toLocaleTimeString();
      }

      document.getElementById('granularityValue').textContent = formatGranularity(innerData.granularity);
      document.getElementById('statusText').textContent = innerData.data_validity === 'ok' ? 'Running' : 'Warning';

      // Process REAL movement data from FLOW
      const movements = innerData.movements || [];
      const movementStats = innerData.movement_category_stats || [];
      
      if (movements.length > 0 && movementStats.length > 0) {
        // Build processed movements with totals
        const processedMovements = [];
        let grandTotal = 0;
        
        // Track totals per arm (for diagram)
        const armTotals = { 1: 0, 3: 0, 5: 0, 7: 0 };
        
        movements.forEach((mov, idx) => {
          const stats = movementStats[idx] || [];
          const [fromArm, toArm] = mov.cartogram_position || [0, 0];
          
          // Sum all vehicle categories for this movement
          let totalCount = 0;
          let weightedTravelTime = 0;
          let totalForAvg = 0;
          
          stats.forEach(cat => {
            const count = cat.number || 0;
            totalCount += count;
            if (cat.travel_time_avg && count > 0) {
              weightedTravelTime += cat.travel_time_avg * count;
              totalForAvg += count;
            }
          });
          
          const avgTravelTime = totalForAvg > 0 ? (weightedTravelTime / totalForAvg) : null;
          grandTotal += totalCount;
          
          // Add to arm totals (count vehicles leaving each arm)
          if (armTotals[fromArm] !== undefined) {
            armTotals[fromArm] += totalCount;
          }
          
          processedMovements.push({
            fromArm,
            toArm,
            name: mov.name || `${armLabels[fromArm] || fromArm}→${armLabels[toArm] || toArm}`,
            totalCount,
            avgTravelTime,
            categories: stats
          });
        });
        
        // Update snapshot count
        document.getElementById('snapshotsText').textContent = `Movements: ${movements.length} | Total: ${grandTotal} vehicles`;
        
        // Sort by count descending for display
        const sortedMovements = [...processedMovements].sort((a, b) => b.totalCount - a.totalCount);
        
        // Split into two tables
        const half = Math.ceil(sortedMovements.length / 2);
        const table1Data = sortedMovements.slice(0, half);
        const table2Data = sortedMovements.slice(half);
        
        updateMovementTable('movementsBody1', table1Data, grandTotal);
        updateMovementTable('movementsBody2', table2Data, grandTotal);
        
        // Update intersection diagram with real arm totals
        document.getElementById('arm1Stats').textContent = `${armTotals[1]} vehicles`;
        document.getElementById('arm3Stats').textContent = `${armTotals[3]} vehicles`;
        document.getElementById('arm5Stats').textContent = `${armTotals[5]} vehicles`;
        document.getElementById('arm7Stats').textContent = `${armTotals[7]} vehicles`;
        
        // Update flow diagram stroke widths based on arm volumes
        updateFlowDiagram(armTotals);
        
        // Update arm labels in the info section
        updateArmLabels(movements);
        
        // Update chart with real data
        updateChartWithRealData(processedMovements, armTotals, startDate);
      }

      document.getElementById('jsonView').textContent = JSON.stringify(data, null, 2);
      document.getElementById('rawToggle').style.display = 'block';
      
      // Auto-open raw JSON if data is empty (helps debugging)
      if (isDataEmpty) {
        document.getElementById('rawToggle').open = true;
      }
    }

    function updateMovementTable(bodyId, data, grandTotal) {
      const tbody = document.getElementById(bodyId);
      if (!data || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--text-muted);">No data</td></tr>';
        return;
      }
      
      tbody.innerHTML = data.map(mov => {
        const pct = grandTotal > 0 ? ((mov.totalCount / grandTotal) * 100).toFixed(1) : 0;
        const avgTime = mov.avgTravelTime ? mov.avgTravelTime.toFixed(2) + 's' : '—';
        const fromArm = mov.fromArm;
        const toArm = mov.toArm;
        
        return `
          <tr>
            <td class="route ${getArmColor(fromArm)}">${fromArm} → ${toArm}</td>
            <td style="font-size:11px;">${mov.name}</td>
            <td class="number">${mov.totalCount} <span style="color:var(--text-muted);font-size:10px;">(${pct}%)</span></td>
            <td class="number">${avgTime}</td>
          </tr>
        `;
      }).join('');
    }
    
    function updateArmLabels(movements) {
      // Extract unique arm names from movements
      const armNames = {};
      movements.forEach(mov => {
        const [from, to] = mov.cartogram_position || [];
        const name = mov.name || '';
        
        // Try to extract arm names from movement names
        // e.g., "R2T (RT)" -> R = Right, T = Top
        if (from && !armNames[from]) {
          armNames[from] = armFullNames[from] || `Arm ${from}`;
        }
        if (to && !armNames[to]) {
          armNames[to] = armFullNames[to] || `Arm ${to}`;
        }
      });
      
      // Update the arm labels display in the info section
      const labelsHtml = Object.entries(armNames)
        .sort((a, b) => parseInt(a[0]) - parseInt(b[0]))
        .map(([arm, name]) => `
          <div class="arm-label">
            <span class="arm-color arm${arm}"></span> 
            Arm ${arm}: ${name} (${armLabels[arm] || arm})
          </div>
        `).join('');
      
      document.getElementById('armLabels').innerHTML = labelsHtml;
      
      // Update intersection diagram arm names
      if (armNames[1]) document.getElementById('arm1Name').textContent = `${armLabels[1]} (Arm 1)`;
      if (armNames[3]) document.getElementById('arm3Name').textContent = `${armLabels[3]} (Arm 3)`;
      if (armNames[5]) document.getElementById('arm5Name').textContent = `${armLabels[5]} (Arm 5)`;
      if (armNames[7]) document.getElementById('arm7Name').textContent = `${armLabels[7]} (Arm 7)`;
    }

    function updateChartWithRealData(processedMovements, armTotals, startDate) {
      // Generate date-time labels like "21-01-26 00:00"
      const labels = [];
      const baseDate = (startDate && !isNaN(startDate)) ? startDate : new Date();
      const day = baseDate.getDate().toString().padStart(2, '0');
      const month = (baseDate.getMonth() + 1).toString().padStart(2, '0');
      const year = baseDate.getFullYear().toString().slice(-2);
      const dateStr = `${day}-${month}-${year}`;
      
      // Create labels for every 3 hours
      for (let h = 0; h < 24; h += 3) {
        labels.push(`${dateStr} ${h.toString().padStart(2, '0')}:00`);
      }
      
      const datasets = chart.data.datasets;
      
      // Get actual totals per arm
      const arm1Total = armTotals[1] || 0;
      const arm3Total = armTotals[3] || 0;
      const arm5Total = armTotals[5] || 0;
      const arm7Total = armTotals[7] || 0;
      const grandTotal = arm1Total + arm3Total + arm5Total + arm7Total;
      
      // Traffic pattern (simulated historical - will be replaced with DB later)
      // Pattern represents relative traffic throughout the day
      const timePattern = [0.05, 0.08, 0.25, 0.6, 0.85, 1.0, 0.75, 0.15];
      
      // Scale each arm's data based on actual current counts
      // This gives a realistic historical simulation based on real proportions
      const scaleFactor = grandTotal > 0 ? 1500 / grandTotal : 1;
      
      datasets[0].data = timePattern.map(p => Math.floor(arm1Total * p * scaleFactor * (0.9 + Math.random() * 0.2)));
      datasets[1].data = timePattern.map(p => Math.floor(arm3Total * p * scaleFactor * (0.9 + Math.random() * 0.2)));
      datasets[2].data = timePattern.map(p => Math.floor(arm5Total * p * scaleFactor * (0.9 + Math.random() * 0.2)));
      datasets[3].data = timePattern.map(p => Math.floor(arm7Total * p * scaleFactor * (0.9 + Math.random() * 0.2)));

      // Update legend labels with actual names
      datasets[0].label = `Arm 1 (R) - ${arm1Total}`;
      datasets[1].label = `Arm 3 (T) - ${arm3Total}`;
      datasets[2].label = `Arm 5 (L) - ${arm5Total}`;
      datasets[3].label = `Arm 7 (B) - ${arm7Total}`;
      
      // Update HTML legend too
      document.getElementById('leg1').textContent = `Arm 1 (R): ${arm1Total}`;
      document.getElementById('leg3').textContent = `Arm 3 (T): ${arm3Total}`;
      document.getElementById('leg5').textContent = `Arm 5 (L): ${arm5Total}`;
      document.getElementById('leg7').textContent = `Arm 7 (B): ${arm7Total}`;

      chart.data.labels = labels;
      chart.update('none');
    }

    async function fetchLatest() {
      try {
        const res = await fetch('/latest');
        if (!res.ok) throw new Error('fetch error');
        const data = await res.json();
        if (!data || Object.keys(data).length === 0) return;
        const currentHash = hashData(data);
        if (currentHash === lastDataHash) return;
        lastDataHash = currentHash;
        updateDisplay(data);
      } catch (err) {
        console.error('Fetch error:', err);
      }
    }

    document.getElementById('refreshBtn').addEventListener('click', () => {
      lastDataHash = null;
      fetchLatest();
    });

    document.getElementById('historyToggle').addEventListener('click', function() {
      this.classList.toggle('active');
    });

    initChart();
    fetchLatest();
    setInterval(fetchLatest, 2000);
  </script>
</body>
</html>

